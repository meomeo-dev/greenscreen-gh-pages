<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁªøÂπïÁîüÊàêÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 760px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #00B140, #00D4AA);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .section-subtitle {
            margin: 12px 0 8px;
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }

        .aspect-ratio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .aspect-btn {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .aspect-btn:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .aspect-btn.active {
            background: #00B140;
            color: white;
            border-color: #00B140;
        }

        .orientation-group {
            margin-top: 6px;
        }

        .custom-input {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
        }

        .custom-input input {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
        }

        .custom-input span {
            text-align: center;
            font-weight: bold;
            color: #666;
        }

        .generate-btn {
            background: linear-gradient(45deg, #00B140, #00D4AA);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 20px 0;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 177, 64, 0.3);
        }

        .result-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .result-section.show {
            display: block;
        }

        .canvas-container {
            text-align: center;
            margin: 20px 0;
        }

        #greenscreen-canvas {
            border: 2px solid #00B140;
            border-radius: 0;
            max-width: 100%;
            height: auto;
        }

        .download-btn,
        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .download-btn:hover,
        .copy-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .prompt-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .prompt-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            margin: 10px 0;
            border: 1px solid #e9ecef;
        }

        .copy-success {
            background: #28a745 !important;
        }

        .info-text {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
            line-height: 1.5;
        }

        /* Layers panel */
        .ws-layers-panel {
            margin-top: 12px;
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
        .ws-layers-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-bottom: 1px solid #f1f3f5;
        }
        .ws-layers-header button {
            background:#6c757d;
            color:#fff;
            border:none;
            padding:6px 10px;
            border-radius:6px;
            cursor:pointer;
            font-weight:600;
        }
        .ws-layers-header button:hover {
            background:#5a6268;
        }
        .ws-layers-content {
            max-height: 180px;
            overflow-y: auto;
            padding: 6px;
        }
        .ws-layer-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 8px;
            border: 1px solid #f1f3f5;
            border-radius: 6px;
            margin: 4px 0;
            cursor: pointer;
            user-select: none;
            background: #f8f9fa;
        }
        .ws-layer-item:hover {
            background: #eef2f3;
        }
        .ws-layer-item.selected {
            border-color: #00B140;
            background: #e6fff1;
        }
        .ws-layer-type {
            width: 22px;
            text-align: center;
        }
        .ws-layer-label {
            flex: 1;
            color: #333;
            font-weight: 600;
        }
        .ws-layer-handle {
            color: #666;
            font-size: 16px;
            cursor: grab;
        }
        .ws-layers-panel.collapsed .ws-layers-content {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ ÁªøÂπïÁîüÊàêÂô®(Á¶ªÁ∫øÁâà, ‰∏çÂ≠òÂÇ®‰ªª‰ΩïÊï∞ÊçÆ)</h1>
            <p>Generate green screen images with custom aspect ratios</p>
        </div>

        <div class="content">
            <div class="form-group">
                <label>ÈÄâÊã©ÂÆΩÈ´òÊØî / Select Aspect Ratio:</label>
                <div class="section-subtitle">Á§æ‰∫§Â™í‰Ωì / Social Media</div>
                <div class="aspect-ratio-grid">
                    <div class="aspect-btn" data-ratio="1:1" data-label="instagram-square">1:1<br><small>Instagram
                            Square</small></div>
                    <div class="aspect-btn" data-ratio="4:5" data-label="instagram-portrait">4:5<br><small>Instagram
                            Portrait</small></div>
                    <div class="aspect-btn" data-ratio="9:16" data-label="story-reels-tiktok">
                        9:16<br><small>Story/Reels/TikTok</small></div>
                    <div class="aspect-btn" data-ratio="1.91:1" data-label="fb-twitter-landscape">
                        1.91:1<br><small>FB/Twitter Landscape</small></div>
                    <div class="aspect-btn" data-ratio="2:3" data-label="pinterest">2:3<br><small>Pinterest</small>
                    </div>
                    <div class="aspect-btn" data-ratio="3:4" data-label="x-portrait">3:4<br><small>X Portrait</small>
                    </div>
                </div>

                <div class="section-subtitle">ËßÜÈ¢ëÂàõ‰Ωú / Video</div>
                <div class="aspect-ratio-grid">
                    <div class="aspect-btn" data-ratio="16:9" data-label="hd-youtube">16:9<br><small>HD/YouTube</small>
                    </div>
                    <div class="aspect-btn" data-ratio="4:3" data-label="classic">4:3<br><small>Classic</small></div>
                    <div class="aspect-btn" data-ratio="3:2" data-label="camera">3:2<br><small>Camera</small></div>
                    <div class="aspect-btn" data-ratio="2.39:1" data-label="cinemascope">
                        2.39:1<br><small>Cinemascope</small></div>
                    <div class="aspect-btn" data-ratio="1.85:1" data-label="academy-flat">1.85:1<br><small>Academy
                            Flat</small></div>
                    <div class="aspect-btn" data-ratio="17:9" data-label="dci">17:9<br><small>DCI</small></div>
                    <div class="aspect-btn" data-ratio="1.43:1" data-label="imax">1.43:1<br><small>IMAX</small></div>
                    <div class="aspect-btn" data-ratio="21:9" data-label="ultra-wide">21:9<br><small>Ultra-wide</small>
                    </div>
                </div>

                <div class="section-subtitle">ÊòæÁ§∫ËÆæÂ§á (2020+) / Displays</div>
                <div class="aspect-ratio-grid">
                    <div class="aspect-btn" data-ratio="16:10" data-label="laptop-16-10">16:10<br><small>Apple MacBook,
                            Dell/Lenovo</small></div>
                    <div class="aspect-btn" data-ratio="3:2" data-label="laptop-3-2">3:2<br><small>Microsoft Surface,
                            Huawei MateBook</small></div>
                    <div class="aspect-btn" data-ratio="16:9" data-label="tv-16-9">16:9<br><small>TV:
                            Samsung/LG/Sony</small></div>
                    <div class="aspect-btn" data-ratio="21:9" data-label="lg-ultrawide">21:9<br><small>LG
                            UltraWide</small></div>
                    <div class="aspect-btn" data-ratio="32:9" data-label="samsung-super-ultrawide">
                        32:9<br><small>Samsung Super UltraWide</small></div>
                </div>

                <div class="section-subtitle">ÁßªÂä®ËÆæÂ§á (2020+) / Mobile</div>
                <div class="aspect-ratio-grid">
                    <div class="aspect-btn" data-ratio="19.5:9" data-label="apple-iphone">19.5:9<br><small>Apple
                            iPhone</small></div>
                    <div class="aspect-btn" data-ratio="20:9" data-label="android-20-9">20:9<br><small>Google
                            Pixel</small></div>
                    <div class="aspect-btn" data-ratio="19:9" data-label="android-19-9">19:9<br><small>Android
                            (common)</small></div>
                    <div class="aspect-btn" data-ratio="2:1" data-label="mobile-2-1">2:1<br><small>Mobile Tall
                            (18:9)</small></div>
                </div>

                <div class="section-subtitle">ÊñπÂêë / Orientation</div>
                <div class="aspect-ratio-grid orientation-group"
                    style="grid-template-columns: repeat(2, minmax(120px, 1fr));">
                    <div class="aspect-btn orientation-btn" data-orientation="landscape">Ê®™Âêë<br><small>Landscape</small>
                    </div>
                    <div class="aspect-btn orientation-btn" data-orientation="portrait">Á∫µÂêë<br><small>Portrait</small>
                    </div>
                </div>

                <div class="custom-input">
                    <input type="number" id="custom-width" placeholder="ÂÆΩÂ∫¶" min="1" max="4000">
                    <span>:</span>
                    <input type="number" id="custom-height" placeholder="È´òÂ∫¶" min="1" max="4000">
                </div>
            </div>



            <div class="result-section" id="result-section">
                <h3>üì∏ ÁîüÊàêÁªìÊûú / Generated Result</h3>
                <div class="canvas-container">
                    <canvas id="greenscreen-canvas"></canvas>
                </div>

                <div style="text-align: center;">
                    <button class="download-btn" onclick="downloadImage(1)">üíæ ‰∏ãËΩΩ1ÂÄçÂõæ Download 1x</button>
                    <button class="download-btn" onclick="downloadImage(2)">üíæ ‰∏ãËΩΩ2ÂÄçÂõæ Download 2x</button>
                    <button class="download-btn" onclick="downloadImage(3)">üíæ ‰∏ãËΩΩ3ÂÄçÂõæ Download 3x</button>
                </div>

                <div class="prompt-section">
                    <h4>üìù AIÊèêÁ§∫ËØçÊ®°Êùø (ÁªøÂπï‰øÆÊîπ) / AI Prompt Template</h4>
                    <div class="prompt-text" id="prompt-text"></div>
                    <button class="copy-btn" id="copy-btn1" onclick="copyPrompt()">
                        üìã Â§çÂà∂ÊèêÁ§∫ËØç Copy Prompt
                    </button>
                </div>

                <div class="prompt-section">
                    <h4>üìù AIÊèêÁ§∫ËØçÊ®°Êùø(n Âêà 1) / AI Prompt Template</h4>
                    <div class="prompt-text" id="prompt-text2"></div>
                    <button class="copy-btn" id="copy-btn2" onclick="copyPrompt2()">
                        üìã Â§çÂà∂ÊèêÁ§∫ËØç Copy Prompt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRatio = '16:9';
        let currentLabel = 'hd-youtube';
        let orientation = 'landscape';

        // È¢ÑËÆæÂÆΩÈ´òÊØîÈÄâÊã©
        document.querySelectorAll('.aspect-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                if (this.dataset.ratio) {
                    document.querySelectorAll('.aspect-btn[data-ratio]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentRatio = this.dataset.ratio;
                    currentLabel = this.dataset.label || 'custom';

                    // Ê∏ÖÁ©∫Ëá™ÂÆö‰πâËæìÂÖ•
                    document.getElementById('custom-width').value = '';
                    document.getElementById('custom-height').value = '';

                    // ÈÄâÊã©È¢ÑËÆæÂç≥Ëá™Âä®Ê∏≤Êüì
                    generateGreenscreen();
                }
            });
        });

        // ÈªòËÆ§ÈÄâ‰∏≠16:9 Âíå Ê®™Âêë
        document.querySelector('[data-ratio="16:9"]').classList.add('active');
        document.querySelector('[data-orientation="landscape"]').classList.add('active');

        // ÊñπÂêëÂàáÊç¢
        document.querySelectorAll('.orientation-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.orientation-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                orientation = this.dataset.orientation;
                // ÂàáÊç¢ÊñπÂêëÂêéÁ´ãÂç≥ÈáçÁªò
                generateGreenscreen();
            })
        });

        // Ëá™ÂÆö‰πâËæìÂÖ•ÁõëÂê¨
        document.getElementById('custom-width').addEventListener('input', updateCustomRatio);
        document.getElementById('custom-height').addEventListener('input', updateCustomRatio);

        function updateCustomRatio() {
            const width = document.getElementById('custom-width').value;
            const height = document.getElementById('custom-height').value;

            if (width && height) {
                document.querySelectorAll('.aspect-btn[data-ratio]').forEach(b => b.classList.remove('active'));
                currentRatio = `${width}:${height}`;
                // ËæìÂÖ•ÊúâÊïàÊó∂Ëá™Âä®Ê∏≤Êüì
                generateGreenscreen();
            }
        }

        function generateGreenscreen() {
            let width, height;

            // Ëé∑ÂèñËá™ÂÆö‰πâÂ∞∫ÂØ∏Êàñ‰ΩøÁî®È¢ÑËÆæÊØî‰æã
            const customWidth = document.getElementById('custom-width').value;
            const customHeight = document.getElementById('custom-height').value;

            let ratioW, ratioH; // Áî®‰∫éËÆ°ÁÆóÊØî‰æãÂ±ïÁ§∫ÔºàÂ∑≤Â∫îÁî®ÊñπÂêëÔºâ
            const isCustom = !!(customWidth && customHeight);

            // ËæÖÂä©ÔºöÊåâÊñπÂêëË∞ÉÊï¥ÂÆΩÈ´ò/ÊØî‰æã
            const applyOrientation = (w, h) => {
                if (orientation === 'landscape' && w < h) return [h, w];
                if (orientation === 'portrait' && w > h) return [h, w];
                return [w, h];
            };

            if (isCustom) {
                let w = parseInt(customWidth);
                let h = parseInt(customHeight);
                [w, h] = applyOrientation(w, h);
                width = w; height = h;
                ratioW = w; ratioH = h;
            } else {
                const [wStr, hStr] = currentRatio.split(':');
                let w = Number(wStr);
                let h = Number(hStr);
                [w, h] = applyOrientation(w, h);
                const baseSize = 400; // Âü∫Á°ÄÂ∞∫ÂØ∏
                const maxWH = Math.max(w, h);
                width = (w / maxWH) * baseSize;
                height = (h / maxWH) * baseSize;
                ratioW = w; ratioH = h;
            }

            const canvas = document.getElementById('greenscreen-canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = width;
            canvas.height = height;

            // ÁªòÂà∂ÁªøÂπïËÉåÊôØÔºàÁ∫ØËâ≤Ôºâ
            ctx.fillStyle = '#00B140';
            ctx.fillRect(0, 0, width, height);

            // Êó†Á∫πÁêÜÁ∫øÊù°Ôºå‰øùÊåÅÁ∫ØËâ≤ËÉåÊôØ
            // ÂèÇËÄÉÊñúÁ∫øÔºö‰ªéÂè≥‰∏äËßíÂà∞Â∑¶‰∏ãËßí
            ctx.strokeStyle = '#00D4AA';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(width, 0);
            ctx.lineTo(0, height);
            ctx.stroke();

            // ÊØî‰æãÊñáÊ°àÔºöÈ¢ÑËÆæÁõ¥Êé•ÊòæÁ§∫ currentRatioÔºõËá™ÂÆö‰πâÊó∂ÊåâÂ∞èËæπÂΩí‰∏ÄÂà∞ 1Ôºå‰øùÁïô 1 ‰ΩçÂ∞èÊï∞
            let aspectText;
            if (isCustom) {
                const minSide = Math.min(ratioW, ratioH);
                const normW = (ratioW / minSide).toFixed(1);
                const normH = (ratioH / minSide).toFixed(1);
                aspectText = `${normW}:${normH}`;
            } else {
                const [wTok, hTok] = currentRatio.split(':');
                // È¢ÑËÆæÊåâÊñπÂêëÊòæÁ§∫Ôºà‰∏çÊäòÁÆóÔºâ
                if (orientation === 'landscape') {
                    aspectText = (Number(wTok) >= Number(hTok)) ? `${wTok}:${hTok}` : `${hTok}:${wTok}`;
                } else {
                    aspectText = (Number(wTok) <= Number(hTok)) ? `${wTok}:${hTok}` : `${hTok}:${wTok}`;
                }
            }
            const p1 = 'Green screen - Update the input image by replacing the green screen according to the description provided on it.';
            const p2 = `The aspect ratio of this image is ${aspectText}`;
            const p3 = 'Do not change the input aspect ratio.';

            // ÊñáÊú¨Ê†∑Âºè‰∏éËá™Âä®Êç¢Ë°å
            ctx.fillStyle = '#00D4AA';
            const fontSize = Math.min(width, height) / 15;
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            const lineHeight = fontSize * 1.2; // Ë°åÈ´ò
            const paddingXConst = fontSize * 0.4;
            const paddingYConst = fontSize * 0.3;
            const maxTextWidth = Math.max(10, width - 2 * paddingXConst - 8); // Á°Æ‰øùÂåÖÂê´ÂÜÖËæπË∑ù‰πü‰∏çË∂äÁïå
            function wrapText(context, text, maxWidth) {
                const words = text.split(' ');
                const lines = [];
                let line = '';
                for (let n = 0; n < words.length; n++) {
                    const testLine = line ? line + ' ' + words[n] : words[n];
                    const metrics = context.measureText(testLine);
                    const testWidth = metrics.width;
                    if (testWidth > maxWidth && line) {
                        lines.push(line);
                        line = words[n];
                    } else {
                        line = testLine;
                    }
                }
                if (line) lines.push(line);
                return lines;
            }

            const wrapped1 = wrapText(ctx, p1, maxTextWidth);
            const wrapped2 = wrapText(ctx, p2, maxTextWidth);
            const wrapped3 = wrapText(ctx, p3, maxTextWidth);
            const allLines = [...wrapped1, '', '', ...wrapped2, '', '', ...wrapped3];
            const nonEmptyCount = allLines.filter(l => l).length;
            const totalSpan = (allLines.length - 1) * lineHeight + nonEmptyCount * paddingYConst;
            let startY = height / 2 - totalSpan / 2;
            allLines.forEach((line, i) => {
                const y = startY + i * lineHeight;
                if (line) {
                    const textWidth = ctx.measureText(line).width;
                    const paddingX = fontSize * 0.4;
                    const paddingY = fontSize * 0.3;
                    // ËÉåÊôØÈÅÆÊå°Áü©ÂΩ¢
                    ctx.fillStyle = '#00B140';
                    ctx.fillRect((width - textWidth) / 2 - paddingX,
                        y - lineHeight / 2 - paddingY / 2,
                        textWidth + paddingX * 2,
                        lineHeight + paddingY);
                    // ÂâçÊôØÊñáÂ≠ó
                    ctx.fillStyle = '#00D4AA';
                    ctx.fillText(line, width / 2, y);
                }
            });

            // Êõ¥Êñ∞ÊèêÁ§∫ËØç
            updatePromptText();

            // ÊòæÁ§∫ÁªìÊûúÂå∫Âüü
            document.getElementById('result-section').classList.add('show');
        }

        function updatePromptText() {
            const promptTemplate = `{{ File: Original Image }}

Update the input image by replacing the green screen according to the description provided on it, ensuring that the new scene blends seamlessly as a whole. The final image should have no green screen(#00B140), reference lines(#00D4AA), borders(#00D4AA) or text description(#00D4AA) visible.

\`\`\`yaml
{{ YAMLÊ†ºÂºèÊèêÁ§∫ËØç }}
\`\`\`

Do not change the input aspect ratio.

Return the drawn picture.`;

            const promptTemplate2 = `{{ File: Original Image }}

Create a new image by combining the elements from the provided images. Take the [element from image 1] and place it with/on the [element from image 2]. The final image should ensure that the new scene blends seamlessly as a whole.

\`\`\`yaml
{{ YAMLÊ†ºÂºèÊèêÁ§∫ËØç }}
\`\`\`

Do not change the input aspect ratio.

Return the drawn picture.`;

            document.getElementById('prompt-text').textContent = promptTemplate;
            document.getElementById('prompt-text2').textContent = promptTemplate2;
        }

        function downloadImage(scale = 1) {
            const link = document.createElement('a');
            const s = Math.max(1, Math.floor(scale));
            const orientTag = (typeof orientation !== 'undefined' && orientation === 'portrait') ? 'portrait' : 'landscape';
            const labelTag = (typeof currentLabel !== 'undefined' && currentLabel) ? currentLabel : 'preset';
            const ratioTag = (typeof currentRatio !== 'undefined' && currentRatio ? currentRatio : '16:9').replace(':', 'x');

            let dataUrl;
            if (window.__exportWorkspacePNG) {
                dataUrl = window.__exportWorkspacePNG(s);
            } else {
                // ÂõûÈÄÄÔºöÁõ¥Êé•ÂØºÂá∫ÂΩìÂâçÁîªÂ∏É
                const canvas = document.getElementById('greenscreen-canvas');
                dataUrl = canvas.toDataURL('image/png');
            }

            link.download = `workspace_${labelTag}_${orientTag}_${ratioTag}_${s}x.png`;
            link.href = dataUrl;
            link.click();
        }

        function copyPrompt() {
            const promptText = document.getElementById('prompt-text').textContent;
            const copyBtn = document.getElementById('copy-btn1');

            navigator.clipboard.writeText(promptText).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Â∑≤Â§çÂà∂ Copied!';
                copyBtn.classList.add('copy-success');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copy-success');
                }, 2000);
            }).catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                // ÈôçÁ∫ßÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = promptText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Â∑≤Â§çÂà∂ Copied!';
                copyBtn.classList.add('copy-success');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copy-success');
                }, 2000);
            });
        }

        function copyPrompt2() {
            const promptText = document.getElementById('prompt-text2').textContent;
            const copyBtn = document.getElementById('copy-btn2');

            navigator.clipboard.writeText(promptText).then(() => {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Â∑≤Â§çÂà∂ Copied!';
                copyBtn.classList.add('copy-success');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copy-success');
                }, 2000);
            }).catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                // ÈôçÁ∫ßÊñπÊ°à
                const textArea = document.createElement('textarea');
                textArea.value = promptText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Â∑≤Â§çÂà∂ Copied!';
                copyBtn.classList.add('copy-success');

                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copy-success');
                }, 2000);
            });
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÁîüÊàêÈªòËÆ§ÁªøÂπï
        window.addEventListener('load', () => {
            generateGreenscreen();
        });

        (function () {
            // Ê≥®ÂÖ•Â∞ëÈáèÊ†∑ÂºèÔºàÂ∑•ÂÖ∑Ê†è‰∏éÊ†áÁ≠æÂàóË°®Ôºâ
            const css = `
    .workspace-toolbar { margin: 12px 0 8px; display: grid; grid-template-columns: 1fr; gap: 8px; }
    .workspace-toolbar .ws-controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .workspace-toolbar button { background:#00B140; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; font-weight:600; }
    .ws-group { border:1px dashed #e9ecef; padding:8px; border-radius:6px; }
    .ws-group-title { font-weight:700; color:#333; margin-right:8px; white-space:nowrap; }
    .workspace-toolbar button:hover { filter:brightness(0.95); }
    .ws-mask-list { display:flex; flex-direction: column; gap: 6px; }
    .ws-mask-item { display:flex; align-items:center; gap:8px; }
    .ws-mask-item input { flex:1; padding:6px 8px; border:1px solid #e9ecef; border-radius:4px; }
    .ws-tip { color:#666; font-size: 12px; }
    `;
            const st = document.createElement('style');
            st.textContent = css;
            document.head.appendChild(st);

            const resultSection = document.getElementById('result-section');
            if (!resultSection) return;

            // ÊûÑÂª∫Â∑•ÂÖ∑Ê†èÔºà‰∏ä‰º†/Ê∑ªÂä†ÁªøÂπï/ÂØºÂá∫ + Ê†áÁ≠æÂàóË°®ÔºâÔºåÊèíÂÖ•Âà∞Áé∞ÊúâÁîªÂ∏É‰∏äÊñπ
            const toolbar = document.createElement('div');
            toolbar.className = 'workspace-toolbar';
            toolbar.innerHTML = `
        <div class="ws-controls ws-group">
            <span class="ws-group-title">ÂèÇËÄÉÂõæÔºàImageÔºâÂ∑•ÂÖ∑ÔΩú‰ΩúÁî®ÂØπË±°ÔºöÈÄâ‰∏≠ÂõæÁâá</span>
            <input id="ws-upload" type="file" accept="image/*" multiple title="ÂØºÂÖ•ÂèÇËÄÉÂõæÔºà‰ΩúÁî®‰∫éÂõæÁâáÂØπË±°Ôºâ">
            <button id="ws-rot-left" type="button" title="ÂØπÈÄâ‰∏≠ÂõæÁâáÊóãËΩ¨ -15¬∞">‚Ü∫ ÊóãËΩ¨-15¬∞</button>
            <button id="ws-rot-right" type="button" title="ÂØπÈÄâ‰∏≠ÂõæÁâáÊóãËΩ¨ +15¬∞">‚Üª ÊóãËΩ¨+15¬∞</button>
            <label style="display:flex;align-items:center;gap:6px;" title="ÂØπÈÄâ‰∏≠ÂõæÁâáËÆæÁΩÆÊóãËΩ¨ËßíÂ∫¶">
                ËßíÂ∫¶
                <input id="ws-rot-range" type="range" min="-180" max="180" step="1" value="0" style="width:120px;">
                <input id="ws-rot-input" type="number" min="-180" max="180" step="1" value="0" style="width:70px;">
            </label>
            <button id="ws-flip-h" type="button" title="ÂØπÈÄâ‰∏≠ÂõæÁâáËøõË°åÊ∞¥Âπ≥ÁøªËΩ¨">‚áã Ê∞¥Âπ≥ÁøªËΩ¨</button>
            <button id="ws-flip-v" type="button" title="ÂØπÈÄâ‰∏≠ÂõæÁâáËøõË°åÂûÇÁõ¥ÁøªËΩ¨">‚áÖ ÂûÇÁõ¥ÁøªËΩ¨</button>
        </div>
        <div class="ws-controls ws-group">
            <span class="ws-group-title">ÁªøÂπïÔºàMaskÔºâÂ∑•ÂÖ∑ÔΩú‰ΩúÁî®ÂØπË±°ÔºöÈÄâ‰∏≠ÁªøÂπïÔºõÊñáÊ°àÊòæÁ§∫‰∏∫ÂÖ®Â±Ä</span>
            <button id="ws-add-mask" type="button" title="Âú®Â∑•‰ΩúÂå∫Ê∑ªÂä†ÂèØÊãñÊãΩÁöÑÁªøÂπïÈÅÆÁΩ©">‚ûï Ê∑ªÂä†ÁªøÂπï</button>
            <label style="display:flex;align-items:center;gap:6px;" title="ÂàáÊç¢ÊòØÂê¶Âú®ÊâÄÊúâÁªøÂπï‰∏äÊòæÁ§∫‰∏âÊÆµÊñáÊ°àÔºàÂÖ®Â±ÄÔºâ">
                <input id="ws-toggle-text" type="checkbox" checked>
                ÊòæÁ§∫ÈÅÆÁΩ©ÊñáÊ°àÔºàÂÖ®Â±ÄÔºâÂãæÈÄâÂêéÂèØÂú®ÂõæÂ±ÇÂàóË°®‰∏≠ÂçïÁã¨ÊéßÂà∂
            </label>
        </div>
        <div class="ws-tip">ÊèêÁ§∫ÔºöÊãñÊãΩÁßªÂä®ÔºõÊãñÊãΩÂè≥‰∏ãËßíÁº©ÊîæÔºõÂõæÁâá‰øùÊåÅÂÆΩÈ´òÊØîÔºõÁªøÂπïÂèØËá™Áî±Áº©ÊîæÔºõÊúÄÂ§öÂØºÂÖ• 10 Âº†ÂõæÁâá„ÄÇ</div>
        <!-- ÊóßÁöÑÁªøÂπïÈù¢ÊùøÈöêËóèÔºåÂ∑≤ÂêàÂπ∂Âà∞‰∏ãÊñπ‚ÄúÂõæÂ±ÇÊ†è‚Äù -->
        <div id="ws-mask-list" class="ws-mask-list" style="display:none;"></div>
    `;
            const canvasContainer = resultSection.querySelector('.canvas-container');
            resultSection.insertBefore(toolbar, canvasContainer);

            // ÊûÑÂª∫ÂõæÂ±ÇÊ†èÔºà‰Ωç‰∫éÂ∑•‰ΩúÂå∫‰∏ãÊñπÔºå‰∏çÂΩ±ÂìçÂ∑•‰ΩúÂå∫ÊØî‰æãÔºâ
            const promptSection = resultSection.querySelector('.prompt-section');
            const layersPanel = document.createElement('div');
            layersPanel.id = 'ws-layers-panel';
            layersPanel.className = 'ws-layers-panel';
            layersPanel.innerHTML = `
                <div class="ws-layers-header">
                    <span class="ws-group-title">ÂõæÂ±ÇÔºàLayersÔºâ</span>
                    <div style="flex:1;"></div>
                    <button id="ws-layers-toggle" type="button">Êî∂Ëµ∑</button>
                </div>
                <div id="ws-layers-content" class="ws-layers-content"></div>
            `;
            if (promptSection) {
                resultSection.insertBefore(layersPanel, promptSection);
            } else {
                resultSection.appendChild(layersPanel);
            }
            let layersCollapsed = false;
            const layersToggleBtn = layersPanel.querySelector('#ws-layers-toggle');
            layersToggleBtn.addEventListener('click', () => {
                layersCollapsed = !layersCollapsed;
                if (layersCollapsed) {
                    layersPanel.classList.add('collapsed');
                    layersToggleBtn.textContent = 'Â±ïÂºÄ';
                } else {
                    layersPanel.classList.remove('collapsed');
                    layersToggleBtn.textContent = 'Êî∂Ëµ∑';
                }
            });

            // ÊóãËΩ¨/ÁøªËΩ¨Êéß‰ª∂ÈÄªËæë
            const rotLeftBtn  = toolbar.querySelector('#ws-rot-left');
            const rotRightBtn = toolbar.querySelector('#ws-rot-right');
            const rotRange    = toolbar.querySelector('#ws-rot-range');
            const rotInput    = toolbar.querySelector('#ws-rot-input');
            const flipHBtn    = toolbar.querySelector('#ws-flip-h');
            const flipVBtn    = toolbar.querySelector('#ws-flip-v');

            function degToRad(d){ return (d * Math.PI) / 180; }
            function radToDeg(r){ return Math.round((r * 180) / Math.PI); }
            function normalizeAngle(r){
                while (r >  Math.PI) r -= 2*Math.PI;
                while (r <= -Math.PI) r += 2*Math.PI;
                return r;
            }
            function getSelectedImage(){
                // ‰ΩøÁî® try/catch ÈÅøÂÖç TDZÔºöstate Âú®ÂàùÂßãÂåñÂâçËÆøÈóÆ‰ºöÊäõ ReferenceError
                try {
                    const o = state?.objects?.[state.selected];
                    return (o && o.type === 'image') ? o : null;
                } catch (e) {
                    return null;
                }
            }
            function syncRotationUI(){
                const img = getSelectedImage();
                const deg = img ? radToDeg(img.rotation || 0) : 0;
                if (rotRange) rotRange.value = String(deg);
                if (rotInput) rotInput.value = String(deg);
            }
            function applyRotation(deltaDeg){
                const img = getSelectedImage();
                if (!img) return;
                img.rotation = normalizeAngle((img.rotation || 0) + degToRad(deltaDeg));
                syncRotationUI();
                render();
            }
            if (rotLeftBtn)  rotLeftBtn.addEventListener('click', () => applyRotation(-15));
            if (rotRightBtn) rotRightBtn.addEventListener('click', () => applyRotation(+15));
            if (rotRange) rotRange.addEventListener('input', (e) => {
                const img = getSelectedImage(); if (!img) return;
                const val = Number(e.target.value || 0);
                img.rotation = normalizeAngle(degToRad(val));
                if (rotInput) rotInput.value = String(val);
                render();
            });
            if (rotInput) rotInput.addEventListener('input', (e) => {
                const img = getSelectedImage(); if (!img) return;
                const raw = Number(e.target.value || 0);
                const val = Math.max(-180, Math.min(180, raw));
                img.rotation = normalizeAngle(degToRad(val));
                if (rotRange) rotRange.value = String(val);
                render();
            });
            if (flipHBtn) flipHBtn.addEventListener('click', () => {
                const img = getSelectedImage(); if (!img) return;
                img.flipH = !img.flipH;
                render();
            });
            if (flipVBtn) flipVBtn.addEventListener('click', () => {
                const img = getSelectedImage(); if (!img) return;
                img.flipV = !img.flipV;
                render();
            });
            // ÂàùÂßãÂêåÊ≠•‰∏ÄÊ¨°
            // Âª∂ËøüÂà∞ÂΩìÂâçÂÆè‰ªªÂä°ÂêéÊâßË°åÔºåÁ°Æ‰øù state Â∑≤ÂàùÂßãÂåñ
            setTimeout(() => syncRotationUI(), 0);
            
            // Â∑•‰ΩúÁ©∫Èó¥ÂÆΩÈ´òÊØîÔºöÊéß‰ª∂ + Ë¶ÜÁõñÈÄªËæëÔºà‰∏çÊîπÂä®Áé∞Êúâ UI ÁöÑÈ¢ÑËÆæÊØî‰æãÔºåÊîØÊåÅÂçïÁã¨ËÆæÁΩÆÂ∑•‰ΩúÂå∫Ôºâ
            let workspaceRatioOverride = null;

            // ÊûÑÂª∫‚ÄúÂ∑•‰ΩúÁ©∫Èó¥ÂÆΩÈ´òÊØî‚ÄùÊéß‰ª∂Ë°å
            const wsRatioRow = document.createElement('div');
            wsRatioRow.className = 'ws-controls';
            wsRatioRow.innerHTML = `
            <span class="ws-group-title">Â∑•‰ΩúÂå∫ÊØî‰æãËÆæÁΩÆÔΩú‰ΩúÁî®ÂØπË±°ÔºöÂ∑•‰ΩúÁ©∫Èó¥</span>
            <input id="ws-ratio-w" type="number" min="1" placeholder="Â∑•‰ΩúÂå∫ÂÆΩW" style="width:100px;padding:6px 8px;border:1px solid #e9ecef;border-radius:4px;" title="Â∑•‰ΩúÂå∫ÂÆΩÔºàWÔºâ">
            <span>:</span>
            <input id="ws-ratio-h" type="number" min="1" placeholder="È´òH" style="width:100px;padding:6px 8px;border:1px solid #e9ecef;border-radius:4px;" title="Â∑•‰ΩúÂå∫È´òÔºàHÔºâ">
            <button id="ws-apply-ratio" type="button" title="Â∞ÜÂ∑¶‰æßÂÆΩÈ´òÂ∫îÁî®Âà∞Â∑•‰ΩúÁ©∫Èó¥ÊØî‰æã">Â∫îÁî®Â∑•‰ΩúÂå∫ÊØî‰æã</button>
            <button id="ws-apply-top" type="button" title="‰ΩøÁî®‰∏äÊñπÈ¢ÑËÆæÊØî‰æãÔºàÂê´ÊñπÂêëÔºâË¶ÜÁõñ‰∏∫Â∑•‰ΩúÂå∫ÊØî‰æã">Â∫îÁî®‰∏äÊñπÊØî‰æã</button>
            `;

            // ÊèíÂÖ•Âà∞ÊèêÁ§∫Ë°å‰πãÂâç
            const wsTipEl = toolbar.querySelector('.ws-tip');
            toolbar.insertBefore(wsRatioRow, wsTipEl);

            // Â°´ÂÖÖËæìÂÖ•Ê°Ü‰∏∫ÂΩìÂâç‰∏äÊñπÈÄâÊã©ÁöÑÊØî‰æãÔºà‰ªÖÂú®Êú™Ë¶ÜÁõñÊó∂ÂêåÊ≠•Ôºâ
            function __wsFillRatioInputs() {
            try {
                const raw = (currentRatio || '16:9').split(':');
                let w = Number(raw[0]), h = Number(raw[1]);
                if (orientation === 'landscape' && w < h) [w, h] = [h, w];
                if (orientation === 'portrait' && w > h) [w, h] = [h, w];
                const wEl = wsRatioRow.querySelector('#ws-ratio-w');
                const hEl = wsRatioRow.querySelector('#ws-ratio-h');
                if (wEl && hEl && !workspaceRatioOverride) { wEl.value = w; hEl.value = h; }
            } catch (e) {}
            }
            __wsFillRatioInputs();

            // ‰∫ã‰ª∂ÔºöÂ∫îÁî®/Ê∏ÖÈô§Ë¶ÜÁõñ
            wsRatioRow.querySelector('#ws-apply-ratio').addEventListener('click', () => {
            let w = Number(wsRatioRow.querySelector('#ws-ratio-w').value);
            let h = Number(wsRatioRow.querySelector('#ws-ratio-h').value);
            // Ëã•Êú™Âú®Êú¨Ë°åËæìÂÖ•ÔºåÂàôÂõûÈÄÄËØªÂèñÈ°µÈù¢È°∂ÈÉ®‚ÄúËá™ÂÆö‰πâÂÆΩÈ´ò‚ÄùËæìÂÖ•Ê°Ü
            if (!(w > 0 && h > 0)) {
                const cwEl = document.getElementById('custom-width');
                const chEl = document.getElementById('custom-height');
                const cw = Number(cwEl && cwEl.value);
                const ch = Number(chEl && chEl.value);
                if (cw > 0 && ch > 0) {
                    w = cw; h = ch;
                    // ÂêåÊ≠•ÂõûÂ°´Âà∞Êú¨Ë°åËæìÂÖ•Ôºå‰æø‰∫éÂêéÁª≠Ë∞ÉÊï¥
                    const wEl = wsRatioRow.querySelector('#ws-ratio-w');
                    const hEl = wsRatioRow.querySelector('#ws-ratio-h');
                    if (wEl && hEl) { wEl.value = String(w); hEl.value = String(h); }
                }
            }
            // ÂÜçÊ¨°Êó†ÊïàÂàôÂõûÈÄÄÂà∞ÂΩìÂâç‰∏äÊñπÈÄâÊã©ÁöÑÊØî‰æã currentRatio
            if (!(w > 0 && h > 0)) {
                try {
                    const raw = (currentRatio || '16:9').split(':');
                    const rw = Number(raw[0]), rh = Number(raw[1]);
                    if (rw > 0 && rh > 0) { w = rw; h = rh; }
                } catch (e) {}
            }
            if (w > 0 && h > 0) {
                workspaceRatioOverride = { w, h };
                updateWorkspaceSize();
            }
            });

            // Â∫îÁî®‰∏äÊñπÊØî‰æãÔºöÂ∞ÜÂΩìÂâç‰∏äÊñπÈÄâÊã©ÔºàÂê´ÊñπÂêëÔºâÂÜôÂÖ•Ë¶ÜÁõñÂπ∂ÈáçÁªò
            wsRatioRow.querySelector('#ws-apply-top').addEventListener('click', () => {
                try {
                    const raw = (currentRatio || '16:9').split(':');
                    let w = Number(raw[0]), h = Number(raw[1]);
                    if (orientation === 'landscape' && w < h) [w, h] = [h, w];
                    if (orientation === 'portrait' && w > h) [w, h] = [h, w];
                    workspaceRatioOverride = { w, h };
                    const wEl = wsRatioRow.querySelector('#ws-ratio-w');
                    const hEl = wsRatioRow.querySelector('#ws-ratio-h');
                    if (wEl && hEl) { wEl.value = w; hEl.value = h; }
                    updateWorkspaceSize();
                } catch (e) {}
            });

            // ÂõûËΩ¶Âø´Êç∑Â∫îÁî®
            ['#ws-ratio-w', '#ws-ratio-h'].forEach(sel => {
            const el = wsRatioRow.querySelector(sel);
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') wsRatioRow.querySelector('#ws-apply-ratio').click();
            });
            });

            // Ë¶ÜÁõñ ratioPairÔºö‰ºòÂÖà‰ΩøÁî®Â∑•‰ΩúÂå∫Ëá™ÂÆö‰πâÂÆΩÈ´òÊØîÔºõÂê¶ÂàôÂõûÈÄÄÂéüÈÄªËæë
            const __ratioPairOrig = ratioPair;
            ratioPair = function () {
            if (workspaceRatioOverride && workspaceRatioOverride.w > 0 && workspaceRatioOverride.h > 0) {
                let w = workspaceRatioOverride.w, h = workspaceRatioOverride.h;
                if (orientation === 'landscape' && w < h) [w, h] = [h, w];
                if (orientation === 'portrait' && w > h) [w, h] = [h, w];
                return [w, h];
            }
            return __ratioPairOrig();
            };

            // ÂΩìÁî®Êà∑ÁÇπÂáª‰∏äÊñπÈ¢ÑËÆæÊØî‰æãÊàñÊñπÂêë‰∏îÊú™Ë¶ÜÁõñÊó∂ÔºåÂêåÊ≠•ËæìÂÖ•Ê°ÜÊòæÁ§∫
            document.querySelectorAll('.aspect-btn[data-ratio], .orientation-btn').forEach(b => {
            b.addEventListener('click', () => setTimeout(() => {
                if (!workspaceRatioOverride) __wsFillRatioInputs();
            }, 0));
            });
            // Â§çÁî®Â∑≤Êúâ canvas ‰Ωú‰∏∫Â∑•‰ΩúÁ©∫Èó¥
            const canvas = document.getElementById('greenscreen-canvas');
            const ctx = canvas.getContext('2d');

            // ËæìÂÖ•Ê°ÜËÅöÁÑ¶Êó∂Ë∑≥ËøáÂõæÂ±ÇÊ†èÂà∑Êñ∞ÔºåÈÅøÂÖçÈáçÂª∫ÂØºËá¥Â§±ÁÑ¶
            let __skipLayersRefresh = false;

            const state = {
                dpr: window.devicePixelRatio || 1,
                cssW: 0,
                cssH: 0,
                showTexts: false,
                objects: [], // { type:'image'|'mask', x,y,w,h, img?, label? }
                selected: -1,
                dragging: null, // { mode:'move'|'resize', dx,dy } for move; resize uses bottom-right handle
            };

            // Âæ™ÁéØÁºñÂè∑Ê±†ÔºöÂõæÁâáÊúÄÂ§ö10ÔºåMaskÊúÄÂ§ö15
            const IMAGE_MAX = 10;
            const MASK_MAX = 15;
            state.imageIdsUsed = new Set();
            state.maskIdsUsed = new Set();
            state.imageNext = 1;
            state.maskNext = 1;

            function __allocSeq(usedSet, nextKey, max) {
                let n = state[nextKey] || 1;
                for (let tries = 0; tries < max; tries++) {
                    if (!usedSet.has(n)) {
                        usedSet.add(n);
                        state[nextKey] = (n % max) + 1;
                        return n;
                    }
                    n = (n % max) + 1;
                }
                return null;
            }
            function allocateImageSeq() { return __allocSeq(state.imageIdsUsed, 'imageNext', IMAGE_MAX); }
            function allocateMaskSeq() { return __allocSeq(state.maskIdsUsed, 'maskNext', MASK_MAX); }
            function releaseImageSeq(n) { if (typeof n === 'number') state.imageIdsUsed.delete(n); }
            function releaseMaskSeq(n) { if (typeof n === 'number') state.maskIdsUsed.delete(n); }

            function ratioPair() {
                const wsToggleEl = toolbar.querySelector('#ws-toggle-text');
                if (wsToggleEl) {
                    wsToggleEl.checked = !!state.showTexts;
                    wsToggleEl.addEventListener('change', (e) => {
                        state.showTexts = !!e.target.checked;
                        render();
                    });
                }
                const raw = (currentRatio || '16:9').split(':');
                let w = Number(raw[0]), h = Number(raw[1]);
                if (orientation === 'landscape' && w < h) [w, h] = [h, w];
                if (orientation === 'portrait' && w > h) [w, h] = [h, w];
                return [w, h];
            }

            function updateWorkspaceSize() {
                const prevW = state.cssW || 0;
                const prevH = state.cssH || 0;

                const containerWidth = resultSection.clientWidth - 40; // ÈÄÇÂ∫¶ÂÜÖËæπË∑ù
                const maxW = Math.max(300, containerWidth);
                const [rw, rh] = ratioPair();
                const cssW = maxW;
                const cssH = Math.round(cssW * (rh / rw));

                state.cssW = cssW;
                state.cssH = cssH;

                const dpr = window.devicePixelRatio || 1;
                state.dpr = dpr;
                canvas.style.width = cssW + 'px';
                canvas.style.height = cssH + 'px';
                canvas.width = Math.round(cssW * dpr);
                canvas.height = Math.round(cssH * dpr);

                // Â∞∫ÂØ∏ÂèòÂåñÊó∂ÊåâÊØî‰æãÊï¥‰ΩìÁº©ÊîæÂØπË±°Ôºå‰øùÊåÅÂ∏ÉÂ±ÄÂ§ß‰Ωì‰∏ÄËá¥
                if (prevW && prevH && (prevW !== cssW || prevH !== cssH)) {
                    const sx = cssW / prevW;
                    const sy = cssH / prevH;
                    state.objects.forEach(o => {
                        o.x *= sx; o.y *= sy; o.w *= sx; o.h *= sy;
                    });
                }

                render();
            }

            function render() {
                const dpr = state.dpr;
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                ctx.clearRect(0, 0, state.cssW, state.cssH);

                // ËÉåÊôØÔºöÁ∫ØÁôΩ
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, state.cssW, state.cssH);

                state.objects.forEach((obj, idx) => {
                    if (obj.type === 'image') {
                        if (obj.img) {
                            ctx.save();
                            const cx = obj.x + obj.w / 2;
                            const cy = obj.y + obj.h / 2;
                            const rot = obj.rotation || 0;
                            const sX = obj.flipH ? -1 : 1;
                            const sY = obj.flipV ? -1 : 1;
                            ctx.translate(cx, cy);
                            ctx.scale(sX, sY);
                            if (rot) ctx.rotate(rot);
                            ctx.drawImage(obj.img, -obj.w / 2, -obj.h / 2, obj.w, obj.h);
                            ctx.restore();
                        }
                        // ‰∏∫ÂõæÁâáÂØπË±°ÁªòÂà∂Â∑¶‰∏äËßíÊ†áÁ≠æÔºà‰∏éÂõæÂ±ÇÊ†èÂêçÁß∞‰∏ÄËá¥Ôºå‰∏çÂèØÁºñËæëÔºâ
                        const __imgTag = obj.seqName || obj.label;
                        if (__imgTag) {
                            ctx.save();
                            ctx.font = 'bold 12px Arial';
                            ctx.textBaseline = 'top';
                            ctx.textAlign = 'start';
                            const padX = 6, padY = 4;
                            const tx = obj.x + 6, ty = obj.y + 6;
                            const tw = ctx.measureText(__imgTag).width;
                            const th = 14; // ÊñáÂ≠óÈ´òÂ∫¶Ëøë‰ºº
                            ctx.fillStyle = '#00B140';
                            ctx.fillRect(tx - padX, ty - padY, tw + padX * 2, th + padY * 2);
                            ctx.fillStyle = '#00D4AA';
                            ctx.fillText(__imgTag, tx, ty);
                            ctx.restore();
                        }
                    } else if (obj.type === 'mask') {
                        // ÁªøÂπï
                        ctx.fillStyle = '#00B140';
                        ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                        ctx.strokeStyle = '#00D4AA';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
                        if (state.showTexts && (obj.showText !== false)) {
                            // ÂèÇËÄÉÊñúÁ∫øÔºö‰ªéÂè≥‰∏äËßíÂà∞Â∑¶‰∏ãËßí
                            ctx.strokeStyle = '#00D4AA';
                            ctx.lineWidth = 2;
                            ctx.beginPath();
                            ctx.moveTo(obj.x + obj.w, obj.y);
                            ctx.lineTo(obj.x, obj.y + obj.h);
                            ctx.stroke();

                            // Ê†áÁ≠æÔºöÂ∑¶‰∏äËßí
                            ctx.fillStyle = '#00D4AA';
                            ctx.font = 'bold 14px Arial';
                            ctx.textBaseline = 'top';
                            ctx.textAlign = 'start';
                            ctx.fillText(obj.label || 'Mask', obj.x + 6, obj.y + 6);

                            // ‰∏âË°åÊñáÊ°àÔºàËá™ÈÄÇÂ∫îÈÅÆÁΩ©Â∞∫ÂØ∏Ôºâ
                            (function drawMaskTexts() {
                                const minSide = Math.min(obj.w, obj.h);
                                const normW = (obj.w / minSide).toFixed(1);
                                const normH = (obj.h / minSide).toFixed(1);
                                const aspectText = `${normW}:${normH}`;

                                const p1 = 'Green screen - Update the input image by replacing the green screen according to the description provided on it.';
                                const p2 = `The aspect ratio of this image is ${aspectText}`;
                                const p3 = 'Do not change the input aspect ratio.';

                                // ÂèØÁî®ÊñáÂ≠óÂå∫ÂüüÔºà‰∏∫Â∑¶‰∏äËßíÊ†áÁ≠æÂíåÂ∫ïÈÉ®ÁïôÂá∫ÂÆâÂÖ®Ë∑ùÁ¶ªÔºâ
                                const safeTop = obj.y + 6 + 14 + 8; // Ê†áÁ≠æ(14px) + padding
                                const safeBottom = obj.y + obj.h - 8;
                                const boxY = safeTop;
                                const boxH = Math.max(10, safeBottom - safeTop);
                                const boxX = obj.x;
                                const boxW = obj.w;

                                function wrapText(context, text, maxWidth) {
                                    const words = text.split(' ');
                                    const lines = [];
                                    let line = '';
                                    for (let n = 0; n < words.length; n++) {
                                        const testLine = line ? line + ' ' + words[n] : words[n];
                                        const metrics = context.measureText(testLine);
                                        if (metrics.width > maxWidth && line) {
                                            lines.push(line);
                                            line = words[n];
                                        } else {
                                            line = testLine;
                                        }
                                    }
                                    if (line) lines.push(line);
                                    return lines;
                                }

                                // ÂàùÂßãÂ≠óÂè∑ÊåâÊúÄÁü≠Ëæπ‰º∞ÁÆóÔºåÈöèÂêéËá™ÈÄÇÂ∫îÁº©Â∞èÁõ¥Ëá≥È´òÂ∫¶ÂèØÂÆπÁ∫≥
                                let fitFS = Math.min(obj.w, obj.h) / 12;
                                let lines = [];
                                let lineHeightLocal = 0;

                                for (let i = 0; i < 10; i++) {
                                    ctx.save();
                                    const paddingX = fitFS * 0.4;
                                    const paddingY = fitFS * 0.3;
                                    const maxTextWidth = Math.max(10, boxW - 2 * paddingX - 8);

                                    ctx.font = `bold ${fitFS}px Arial`;
                                    const w1 = wrapText(ctx, p1, maxTextWidth);
                                    const w2 = wrapText(ctx, p2, maxTextWidth);
                                    const w3 = wrapText(ctx, p3, maxTextWidth);
                                    ctx.restore();

                                    lines = [...w1, '', '', ...w2, '', '', ...w3];
                                    lineHeightLocal = fitFS * 1.2;

                                    const nonEmpty = lines.filter(Boolean).length;
                                    const totalSpan = (lines.length - 1) * lineHeightLocal + nonEmpty * paddingY;

                                    if (totalSpan <= boxH) break;

                                    const ratio = Math.max(0.5, boxH / (totalSpan + 0.0001));
                                    fitFS = Math.max(6, fitFS * ratio * 0.98);
                                }

                                const paddingY = fitFS * 0.3;
                                const nonEmpty = lines.filter(Boolean).length;
                                const totalSpan = (lines.length - 1) * lineHeightLocal + nonEmpty * paddingY;
                                // Â∞ÜËµ∑Âßã Y Èí≥Âà∂Ôºå‰øùËØÅÈ¶ñË°åËÉåÊôØÁü©ÂΩ¢È°∂ÈÉ®‰∏çË∂äËøáÊ†áÁ≠æÂÆâÂÖ®Âå∫
                                let startY = Math.max(
                                    boxY + lineHeightLocal / 2 + paddingY / 2,
                                    boxY + (boxH - totalSpan) / 2
                                );

                                // Ë£ÅÂâ™Âà∞ÊñáÊú¨ÂèØÁî®Âå∫ÂüüÔºåÈÅøÂÖçË∂ÖÂÆΩÊØîÊó∂Ë∂äÁïåË¢´‚ÄúÁ°¨Êà™Êñ≠‚ÄùÁöÑËßÜËßâÈóÆÈ¢ò
                                ctx.save();
                                ctx.beginPath();
                                ctx.rect(boxX, boxY, boxW, boxH);
                                ctx.clip();

                                ctx.font = `bold ${fitFS}px Arial`;
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';

                                lines.forEach((line, i) => {
                                    const y = startY + i * lineHeightLocal;
                                    if (line) {
                                        const textWidth = ctx.measureText(line).width;
                                        const paddingX = fitFS * 0.4;
                                        const paddingY = fitFS * 0.3;
                                        // ËÉåÊôØÈÅÆÊå°Áü©ÂΩ¢ÔºàÂú® clip ÂÜÖÔºå‰∏ç‰ºö‰æµÂÖ•Ê†áÁ≠æÔºâ
                                        ctx.fillStyle = '#00B140';
                                        ctx.fillRect(
                                            obj.x + (obj.w - textWidth) / 2 - paddingX,
                                            y - lineHeightLocal / 2 - paddingY / 2,
                                            textWidth + paddingX * 2,
                                            lineHeightLocal + paddingY
                                        );
                                        // ÂâçÊôØÊñáÂ≠ó
                                        ctx.fillStyle = '#00D4AA';
                                        ctx.fillText(line, obj.x + obj.w / 2, y);
                                    }
                                });
                                ctx.restore();
                            })();
                        } else {
                            // ‰ªÖÊ†áÁ≠æÔºöÂ±Ö‰∏≠ÊòæÁ§∫
                            ctx.save();
                            ctx.fillStyle = '#00D4AA';
                            ctx.font = 'bold 14px Arial';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            // Â¢®ÁªøËâ≤ËÉåÊôØÂùóÔºåÂ∞∫ÂØ∏Âü∫‰∫éÊñáÂ≠óÊµãÈáèÂπ∂ÁïôÂá∫ÂÜÖËæπË∑ù
                            (function () {
                                const label = obj.label || 'Mask';
                                const fs = parseInt(ctx.font, 10) || 14;
                                const paddingX = Math.max(6, fs * 0.6);
                                const paddingY = Math.max(4, fs * 0.4);
                                const textWidth = ctx.measureText(label).width;
                                const cx = obj.x + obj.w / 2;
                                const cy = obj.y + obj.h / 2;

                                // ËÉåÊôØ‰ΩøÁî®Â¢®ÁªøËâ≤ÔºåÈ£éÊ†º‰∏éÁªøÂπï‰∏ÄËá¥‰∏îÊõ¥ÂéãÊöó
                                ctx.fillStyle = '#00B140';
                                ctx.fillRect(
                                    cx - textWidth / 2 - paddingX,
                                    cy - fs / 2 - paddingY,
                                    textWidth + paddingX * 2,
                                    fs + paddingY * 2
                                );

                                // ÂâçÊôØÊñáÂ≠óÁª¥ÊåÅÊµÖÁªøËâ≤
                                ctx.fillStyle = '#00D4AA';
                                ctx.fillText(label, cx, cy);
                            })();
                            ctx.restore();
                        }
                    }

                    // ÈÄâ‰∏≠ÊÄÅÔºöËôöÁ∫øÊ°Ü + Âè≥‰∏ãËßíÁº©ÊîæÊâãÊüÑ
                    if (idx === state.selected) {
                        ctx.save();
                        ctx.strokeStyle = '#006F2A';
                        ctx.setLineDash([6, 4]);
                        ctx.lineWidth = 1.5;
                        ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
                        ctx.setLineDash([]);
                        const hs = 10;
                        ctx.fillStyle = '#006F2A';
                        ctx.fillRect(obj.x + obj.w - hs, obj.y + obj.h - hs, hs, hs);
                        ctx.restore();
                    }
                });
                state.objects.forEach((obj) => {
                    // ÂõæÁâáÔºöÊÄªÊòØË¶ÜÁõñÁªòÂà∂‰∏ÄÊ¨°Â∑¶‰∏äËßíÊ†áÁ≠æ
                    if (obj.type === 'image') {
                        const __imgTag = obj.seqName || obj.label;
                        if (__imgTag) {
                            ctx.save();
                            ctx.font = 'bold 12px Arial';
                            ctx.textBaseline = 'top';
                            ctx.textAlign = 'start';
                            const padX = 6, padY = 4;
                            const tx = obj.x + 6, ty = obj.y + 6;
                            const tw = ctx.measureText(__imgTag).width;
                            const th = 14;
                            ctx.fillStyle = '#00B140';
                            ctx.fillRect(tx - padX, ty - padY, tw + padX * 2, th + padY * 2);
                            ctx.fillStyle = '#00D4AA';
                            ctx.fillText(__imgTag, tx, ty);
                            ctx.restore();
                        }
                    }
                    // ÁªøÂπïÔºö‰ªÖÂú®ÊòæÁ§∫ÊñáÊ°àÊ®°Âºè‰∏ãÔºàÂ∑¶‰∏äËßíÊúâÊ†áÁ≠æÔºâÂÜçÂè†Âä†‰∏ÄÊ¨°Â∑¶‰∏äËßíÊ†áÁ≠æ
                    else if (obj.type === 'mask' && state.showTexts && (obj.showText !== false)) {
                        ctx.save();
                        ctx.fillStyle = '#00D4AA';
                        ctx.font = 'bold 14px Arial';
                        ctx.textBaseline = 'top';
                        ctx.textAlign = 'start';
                        ctx.fillText(obj.label || 'Mask', obj.x + 6, obj.y + 6);
                        ctx.restore();
                    }
                });
                if (!__skipLayersRefresh && typeof refreshLayersPanel === 'function') {
                    refreshLayersPanel();
                }
            }

            function hitTest(x, y) {
                for (let i = state.objects.length - 1; i >= 0; i--) {
                    const o = state.objects[i];
                    if (x >= o.x && y >= o.y && x <= o.x + o.w && y <= o.y + o.h) {
                        const hs = 12;
                        if (x >= o.x + o.w - hs && y >= o.y + o.h - hs) {
                            return { index: i, onHandle: true };
                        }
                        return { index: i, onHandle: false };
                    }
                }
                return { index: -1, onHandle: false };
            }

            // Èº†Ê†á‰∫§‰∫í
            canvas.addEventListener('mousemove', (e) => {
                if (state.dragging) return; // ÊãñÊãΩ‰∏≠‰∏çÊîπ cursor
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                const hit = hitTest(x, y);
                if (hit.index >= 0) {
                    canvas.style.cursor = hit.onHandle ? 'nwse-resize' : 'move';
                } else {
                    canvas.style.cursor = 'default';
                }
            });

            canvas.addEventListener('mousedown', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                const hit = hitTest(x, y);
                state.selected = hit.index;

                if (state.selected >= 0) {
                    // ÁΩÆÈ°∂
                    const o = state.objects.splice(state.selected, 1)[0];
                    state.objects.push(o);
                    state.selected = state.objects.length - 1;

                    if (hit.onHandle) {
                        state.dragging = { mode: 'resize' };
                        o._aspect = o.w / o.h;
                    } else {
                        state.dragging = { mode: 'move', dx: x - o.x, dy: y - o.y };
                    }
                    canvas.style.cursor = hit.onHandle ? 'nwse-resize' : 'move';
                } else {
                    state.dragging = null;
                    canvas.style.cursor = 'default';
                    if (typeof syncRotationUI === 'function') syncRotationUI();
                }
                render();
            });

            window.addEventListener('mousemove', (e) => {
                if (!state.dragging || state.selected < 0) return;
                const o = state.objects[state.selected];
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;

                if (state.dragging.mode === 'move') {
                    o.x = x - state.dragging.dx;
                    o.y = y - state.dragging.dy;
                } else if (state.dragging.mode === 'resize') {
                    let newW = Math.max(20, x - o.x);
                    let newH = Math.max(20, y - o.y);
                    if (o.type === 'image') {
                        const a = o._aspect || (o.w / o.h);
                        if (newW / newH > a) newW = newH * a;
                        else newH = newW / a;
                    }
                    o.w = newW;
                    o.h = newH;
                }
                render();
            });

            window.addEventListener('mouseup', () => {
                state.dragging = null;
                canvas.style.cursor = 'default';
            });

            // ‰∏ä‰º†ÂõæÁâáÔºàÊúÄÂ§ö 10 Âº†Ôºâ
            document.getElementById('ws-upload').addEventListener('change', (e) => {
                const files = Array.from(e.target.files || []);
                const exists = state.objects.filter(o => o.type === 'image').length;
                const allow = Math.max(0, 10 - exists);
                const chosen = files.slice(0, allow);
                chosen.forEach((file, idx) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const img = new Image();
                        img.onload = () => {
                            const maxW = state.cssW * 0.45;
                            const scale = Math.min(1, maxW / img.width);
                            const w = Math.max(40, img.width * scale);
                            const h = Math.max(40, img.height * scale);
                            const offset = idx * 12;
                            const obj = {
                                type: 'image',
                                img,
                                x: (state.cssW - w) / 2 + offset,
                                y: (state.cssH - h) / 2 + offset,
                                w, h,
                                rotation: 0,
                                flipH: false,
                                flipV: false
                            };

                            // ÂàÜÈÖçÂõæÁâáÂ∫èÂè∑ÔºàÂæ™ÁéØÊ±† 1..10ÔºâÔºå‰∏çË∂≥ÂàôÊèêÁ§∫
                            const seq = allocateImageSeq();
                            if (seq == null) { alert('Êó†Ê≥ïÊ∑ªÂä†ÂõæÁâáÔºöÂ∑≤ËææÂà∞ 10 Âº†‰∏äÈôê'); return; }
                            obj.seqId = seq;
                            obj.seqName = `Image ${seq}`;
                            obj.label = obj.seqName;

                            state.objects.push(obj);
                            state.selected = state.objects.length - 1;
                            if (typeof syncRotationUI === 'function') syncRotationUI();
                            render();
                        };
                        img.src = reader.result;
                    };
                    reader.readAsDataURL(file);
                });
                e.target.value = '';
            });

            // ÂõæÂ±ÇÊ†èÔºöÊ∏≤Êüì‰∏éÊãñÊãΩÊéíÂ∫è
            function refreshLayersPanel() {
                const panel = document.getElementById('ws-layers-panel');
                const content = document.getElementById('ws-layers-content');
                if (!panel || !content) return;

                content.innerHTML = '';
                state.objects.forEach((o, idx) => {
                    const item = document.createElement('div');
                    item.className = 'ws-layer-item' + (idx === state.selected ? ' selected' : '');
                    item.setAttribute('draggable', 'true');
                    item.dataset.index = String(idx);

                    const type = document.createElement('span');
                    type.className = 'ws-layer-type';
                    type.textContent = o.type === 'image' ? 'üñºÔ∏è' : 'üü©';

                    const label = document.createElement('span');
                    label.className = 'ws-layer-label';
                    label.textContent = o.label || (o.type === 'image' ? 'Image' : 'Mask');

                    const handle = document.createElement('span');
                    handle.className = 'ws-layer-handle';
                    handle.textContent = '‚â°';

                    // ÈùôÊÄÅÂ∫èÂè∑Ê†áÁ≠æÔºöImage N / Mask NÔºàÂõ∫ÂÆöÔºå‰∏çÈöèÈáçÊéíÊîπÂèòÔºå‰∏çÂèØÁºñËæëÔºâ
                    const staticName = document.createElement('span');
                    staticName.className = 'ws-layer-label';
                    staticName.textContent = o.type === 'image'
                        ? (o.seqName || o.label || 'Image')
                        : (o.seqName || 'Mask');

                    item.appendChild(type);
                    item.appendChild(staticName);

                    // ÁªøÂπïÔºöÊèê‰æõËá™ÂÆö‰πâÊ†áÁ≠æ‰∏éÂà†Èô§ÊåâÈíÆÔºõÂõæÁâáÔºö‰ªÖÊèê‰æõÂà†Èô§ÊåâÈíÆ
                    if (o.type === 'mask') {
                        const nameInput = document.createElement('input');
                        nameInput.type = 'text';
                        nameInput.placeholder = 'Ê†áÁ≠æÂêç';
                        nameInput.value = o.label || '';
                        nameInput.style.flex = '1';
                        nameInput.style.minWidth = '120px';

                        const delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.textContent = 'üóëÔ∏è';
                        delBtn.title = 'Âà†Èô§Ê≠§ÁªøÂπï';

                        // ÈòªÊ≠¢ËæìÂÖ•‰∏éÊåâÈíÆÂÜíÊ≥°ÔºåÈÅøÂÖçËØØÈÄâ‰∏≠ÊàñÊãñÊãΩ
                        ['click','mousedown','mouseup','dblclick','keydown','keyup','input'].forEach(ev => {
                            nameInput.addEventListener(ev, e => e.stopPropagation());
                        });
                        ['click','mousedown','mouseup','dblclick','keydown','keyup'].forEach(ev => {
                            delBtn.addEventListener(ev, e => e.stopPropagation());
                        });

                        // ËÅöÁÑ¶Êó∂ÈîÅÂÆöÔºåÈÅøÂÖç render ÈáçÂª∫ÂØºËá¥ËæìÂÖ•Â§±ÁÑ¶ÔºõÂ§±ÁÑ¶ÂêéÂÜçËß¶Âèë‰∏ÄÊ¨°ÂÆâÂÖ®Ê∏≤Êüì
                        nameInput.addEventListener('focus', () => { __skipLayersRefresh = true; });
                        nameInput.addEventListener('blur', () => { __skipLayersRefresh = false; render(); });

                        // ËæìÂÖ•ËÅîÂä®Ëá™ÂÆö‰πâÊ†áÁ≠æÔºàËæìÂÖ•ËøáÁ®ã‰∏≠Ë∑≥ËøáÂõæÂ±ÇÊ†èÂà∑Êñ∞Ôºå‰øùÊåÅÁÑ¶ÁÇπ‰∏éÂÖâÊ†áÔºâ
                        nameInput.addEventListener('input', () => {
                            o.label = nameInput.value;
                            __skipLayersRefresh = true;
                            render();
                        });

                        // Âà†Èô§ÁªøÂπïÂØπË±°
                        delBtn.addEventListener('click', () => {
                            const removeAt = state.objects.indexOf(o);
                            if (removeAt >= 0) {
                                // ÈáäÊîæÁºñÂè∑
                                if (typeof o.seqId === 'number') releaseMaskSeq(o.seqId);
                                state.objects.splice(removeAt, 1);
                                if (state.selected >= state.objects.length) {
                                    state.selected = state.objects.length - 1;
                                }
                                render();
                            }
                        });

                        item.appendChild(nameInput);

                        // Áã¨Á´ãÂºÄÂÖ≥ÔºöÊòØÂê¶ÊòæÁ§∫ËØ•ÈÅÆÁΩ©ÁöÑÊñáÊ°àÔºà‰∏éÂÖ®Â±ÄÊÄªÂºÄÂÖ≥ÂÖ±ÂêåÁîüÊïàÔºâ
                        const showWrap = document.createElement('label');
                        showWrap.style.display = 'flex';
                        showWrap.style.alignItems = 'center';
                        showWrap.style.gap = '6px';
                        showWrap.title = 'ÊòæÁ§∫ÈÅÆÁΩ©ÊñáÊ°à';

                        const showCb = document.createElement('input');
                        showCb.type = 'checkbox';
                        showCb.checked = (o.showText !== false);

                        const showTxt = document.createElement('span');
                        showTxt.textContent = 'ÊñáÊ°à';

                        // ÈòªÊ≠¢ÂÜíÊ≥°ÔºåÈÅøÂÖçÂΩ±ÂìçÈÄâ‰∏≠/ÊãñÊãΩ
                        ['click','mousedown','mouseup','dblclick','keydown','keyup','change'].forEach(ev => {
                            showCb.addEventListener(ev, e => e.stopPropagation());
                            showWrap.addEventListener(ev, e => e.stopPropagation());
                        });

                        showCb.addEventListener('change', () => {
                            o.showText = showCb.checked;
                            render();
                        });

                        showWrap.appendChild(showCb);
                        showWrap.appendChild(showTxt);
                        item.appendChild(showWrap);

                        item.appendChild(delBtn);
                    } else if (o.type === 'image') {
                        // ‰∏∫ÂõæÁâáÊèê‰æõÂà†Èô§ÊåâÈíÆÔºà‰∏çÊèê‰æõÈáçÂëΩÂêçÔºâ
                        const delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.textContent = 'üóëÔ∏è';
                        delBtn.title = 'Âà†Èô§Ê≠§ÂõæÁâá';

                        ['click','mousedown','mouseup','dblclick','keydown','keyup'].forEach(ev => {
                            delBtn.addEventListener(ev, e => e.stopPropagation());
                        });

                        delBtn.addEventListener('click', () => {
                            const removeAt = state.objects.indexOf(o);
                            if (removeAt >= 0) {
                                // ÈáäÊîæÁºñÂè∑
                                if (typeof o.seqId === 'number') releaseImageSeq(o.seqId);
                                state.objects.splice(removeAt, 1);
                                if (state.selected >= state.objects.length) {
                                    state.selected = state.objects.length - 1;
                                }
                                if (typeof syncRotationUI === 'function') syncRotationUI();
                                render();
                            }
                        });
                        
                        item.appendChild(delBtn);
                    }
                    
                    item.appendChild(handle);

                    // ÁÇπÂáªËÅîÂä®ÈÄâ‰∏≠
                    item.addEventListener('click', () => {
                        state.selected = idx;
                        if (typeof syncRotationUI === 'function') syncRotationUI();
                        render();
                    });

                    // ÊãñÊãΩÊéíÂ∫è
                    item.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', String(idx));
                        item.classList.add('dragging');
                    });
                    item.addEventListener('dragend', () => {
                        item.classList.remove('dragging');
                    });
                    item.addEventListener('dragover', (e) => {
                        e.preventDefault();
                    });
                    item.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const src = parseInt(e.dataTransfer.getData('text/plain'), 10);
                        const dst = parseInt(item.dataset.index, 10);
                        if (isNaN(src) || isNaN(dst) || src === dst) return;
                        const moved = state.objects.splice(src, 1)[0];
                        const insertAt = src < dst ? dst - 1 : dst;
                        state.objects.splice(insertAt, 0, moved);
                        state.selected = insertAt;
                        render();
                    });

                    content.appendChild(item);
                });
            }

            // Ê∑ªÂä†ÁªøÂπïÔºà‰∏çÈîÅÂÆöÂÆΩÈ´òÊØîÔºâ
            function refreshMaskList() {
                const list = document.getElementById('ws-mask-list');
                const masks = state.objects.map((o, idx) => ({ o, idx })).filter(t => t.o.type === 'mask');
                list.innerHTML = '';
                masks.forEach(({ o, idx }, i) => {
                    const row = document.createElement('div');
                    row.className = 'ws-mask-item';
                    row.innerHTML = `
            <span style="min-width:48px;color:#333;">ÁªøÂπï${i + 1}</span>
            <input type="text" value="${o.label || ''}" placeholder="Ê†áÁ≠æ">
            <button type="button" class="ws-mask-del" title="Âà†Èô§">üóëÔ∏è</button>
        `;
                    const input = row.querySelector('input');
                    input.addEventListener('input', () => { o.label = input.value; render(); });

                    // Âà†Èô§ÊåâÈíÆÔºöÂà†Èô§ÂØπÂ∫îÁªøÂπïÔºå‰∏çÂΩ±ÂìçÂÖ∂‰ªñÂØπË±°ÔºõÊõ¥Êñ∞ÈÄâ‰∏≠ÊÄÅ„ÄÅÂàóË°®‰∏éÁîªÂ∏É
                    const delBtn = row.querySelector('.ws-mask-del');
                    delBtn.addEventListener('click', (ev) => {
                        ev.stopPropagation();
                        // ÈáäÊîæÁºñÂè∑
                        if (typeof o.seqId === 'number') releaseMaskSeq(o.seqId);
                        state.objects.splice(idx, 1);
                        if (state.selected >= state.objects.length) {
                            state.selected = state.objects.length - 1;
                        }
                        refreshMaskList();
                        render();
                    });
                    row.addEventListener('click', () => { state.selected = idx; render(); });
                    list.appendChild(row);
                });
            }

            document.getElementById('ws-add-mask').addEventListener('click', () => {
                const [rw, rh] = __ratioPairOrig(); // ‰ΩøÁî®‰∏äÊñπÈÄâÊã©ÊØî‰æã‰∏éÊñπÂêëÔºå‰∏çÂèóÂ∑•‰ΩúÂå∫Ë¶ÜÁõñÂΩ±Âìç
                const maxW = state.cssW * 0.5;
                const maxH = state.cssH * 0.5;
                let w = maxW;
                let h = (w * rh) / rw;
                if (h > maxH) {
                    h = maxH;
                    w = (h * rw) / rh;
                }
                // ÂàÜÈÖç Mask Â∫èÂè∑ÔºàÂæ™ÁéØÊ±† 1..15ÔºâÔºå‰∏çË∂≥ÂàôÊèêÁ§∫
                const seq = allocateMaskSeq();
                if (seq == null) { alert('Êó†Ê≥ïÊ∑ªÂä†ÁªøÂπïÔºöÂ∑≤ËææÂà∞ 15 ‰∏™‰∏äÈôê'); return; }
                const obj = {
                    type: 'mask',
                    x: (state.cssW - w) / 2,
                    y: (state.cssH - h) / 2,
                    w, h,
                    // Ëá™ÂÆö‰πâÊ†áÁ≠æÁã¨Á´ãÔºåÈªòËÆ§Á©∫ÔºõÂ∑•‰ΩúÂå∫ÊòæÁ§∫Ê≠§Ê†áÁ≠æÔºõÂõæÂ±ÇÊ†èÊòæÁ§∫Âõ∫ÂÆöÂ∫èÂè∑Âú® staticName
                    label: '',
                    showText: true,
                    // Âõ∫ÂÆöÂ∫èÂè∑ÂêçÔºà‰∏çÂèòÊõ¥„ÄÅ‰∏çÂèóÈáçÊéíÂΩ±ÂìçÔºâ
                    seqId: seq,
                    seqName: `Mask ${seq}`
                };
                state.objects.push(obj);
                state.selected = state.objects.length - 1;
                refreshMaskList();
                render();
            });

            // ÂØºÂá∫Â∑•‰ΩúÁ©∫Èó¥‰∏∫ÂõæÁâáÔºàPNGÔºâ
            window.__exportWorkspacePNG = function (scale = 1) {
                const s = Math.max(1, Math.floor(scale));
                const off = document.createElement('canvas');
                const w = Math.round(state.cssW * s);
                const h = Math.round(state.cssH * s);
                off.width = w; off.height = h;
                const c = off.getContext('2d');

                // ‰ª• CSS ÂùêÊ†áÁ≥ªÁªòÂà∂ÔºåÊîæÂ§ß s ÂÄçËæìÂá∫
                c.setTransform(s, 0, 0, s, 0, 0);

                // ÁôΩËâ≤ËÉåÊôØ
                c.fillStyle = '#ffffff';
                c.fillRect(0, 0, state.cssW, state.cssH);

                // ÁªòÂà∂ÂØπË±°
                state.objects.forEach(obj => {
                    if (obj.type === 'image') {
                        if (obj.img) {
                            c.save();
                            const cx = obj.x + obj.w / 2;
                            const cy = obj.y + obj.h / 2;
                            const rot = obj.rotation || 0;
                            const sX = obj.flipH ? -1 : 1;
                            const sY = obj.flipV ? -1 : 1;
                            c.translate(cx, cy);
                            c.scale(sX, sY);
                            if (rot) c.rotate(rot);
                            c.drawImage(obj.img, -obj.w / 2, -obj.h / 2, obj.w, obj.h);
                            c.restore();
                        }
                    } else if (obj.type === 'mask') {
                        // ÁªøÂπï‰∏éÊèèËæπ
                        c.fillStyle = '#00B140';
                        c.fillRect(obj.x, obj.y, obj.w, obj.h);
                        c.strokeStyle = '#00D4AA';
                        c.lineWidth = 2;
                        c.strokeRect(obj.x, obj.y, obj.w, obj.h);

                        if (state.showTexts && (obj.showText !== false)) {
                            // ÂèÇËÄÉÊñúÁ∫ø
                            c.strokeStyle = '#00D4AA';
                            c.lineWidth = 2;
                            c.beginPath();
                            c.moveTo(obj.x + obj.w, obj.y);
                            c.lineTo(obj.x, obj.y + obj.h);
                            c.stroke();
                            // Ê†áÁ≠æÔºöÂ∑¶‰∏äËßí
                            c.fillStyle = '#00D4AA';
                            c.font = 'bold 14px Arial';
                            c.textBaseline = 'top';
                            c.textAlign = 'start';
                            c.fillText(obj.label || 'Mask', obj.x + 6, obj.y + 6);

                            // ‰∏âË°åÊñáÊ°àÔºàÂØºÂá∫ÂêåÊ†∑Ëá™ÈÄÇÂ∫îÔºâ
                            const minSide = Math.min(obj.w, obj.h);
                            const normW = (obj.w / minSide).toFixed(1);
                            const normH = (obj.h / minSide).toFixed(1);
                            const aspectText = `${normW}:${normH}`;

                            const p1 = 'Green screen - Update the input image by replacing the green screen according to the description provided on it.';
                            const p2 = `The aspect ratio of this image is ${aspectText}`;
                            const p3 = 'Do not change the input aspect ratio.';

                            const safeTop = obj.y + 6 + 14 + 8;
                            const safeBottom = obj.y + obj.h - 8;
                            const boxY = safeTop;
                            const boxH = Math.max(10, safeBottom - safeTop);
                            const boxX = obj.x;
                            const boxW = obj.w;

                            function wrapText(context, text, maxWidth) {
                                const words = text.split(' ');
                                const lines = [];
                                let line = '';
                                for (let n = 0; n < words.length; n++) {
                                    const testLine = line ? line + ' ' + words[n] : words[n];
                                    const metrics = context.measureText(testLine);
                                    if (metrics.width > maxWidth && line) {
                                        lines.push(line);
                                        line = words[n];
                                    } else {
                                        line = testLine;
                                    }
                                }
                                if (line) lines.push(line);
                                return lines;
                            }

                            let fitFS = Math.min(obj.w, obj.h) / 12;
                            let lines = [];
                            let lineHeightLocal = 0;

                            for (let i = 0; i < 10; i++) {
                                c.save();
                                const paddingX = fitFS * 0.4;
                                const paddingY = fitFS * 0.3;
                                const maxTextWidth = Math.max(10, boxW - 2 * paddingX - 8);

                                c.font = `bold ${fitFS}px Arial`;
                                const w1 = wrapText(c, p1, maxTextWidth);
                                const w2 = wrapText(c, p2, maxTextWidth);
                                const w3 = wrapText(c, p3, maxTextWidth);
                                c.restore();

                                lines = [...w1, '', '', ...w2, '', '', ...w3];
                                lineHeightLocal = fitFS * 1.2;

                                const nonEmpty = lines.filter(Boolean).length;
                                const totalSpan = (lines.length - 1) * lineHeightLocal + nonEmpty * paddingY;

                                if (totalSpan <= boxH) break;

                                const ratio = Math.max(0.5, boxH / (totalSpan + 0.0001));
                                fitFS = Math.max(6, fitFS * ratio * 0.98);
                            }

                            const paddingY = fitFS * 0.3;
                            const nonEmpty = lines.filter(Boolean).length;
                            const totalSpan = (lines.length - 1) * lineHeightLocal + nonEmpty * paddingY;
                            // Â∞ÜËµ∑Âßã Y Èí≥Âà∂Ôºå‰øùËØÅÈ¶ñË°åËÉåÊôØÁü©ÂΩ¢È°∂ÈÉ®‰∏çË∂äËøáÊ†áÁ≠æÂÆâÂÖ®Âå∫
                            let startY = Math.max(
                                boxY + lineHeightLocal / 2 + paddingY / 2,
                                boxY + (boxH - totalSpan) / 2
                            );

                            // Ë£ÅÂâ™Âà∞ÊñáÊú¨ÂèØÁî®Âå∫ÂüüÔºåÂØºÂá∫ÁªìÊûú‰∏ÄËá¥
                            c.save();
                            c.beginPath();
                            c.rect(boxX, boxY, boxW, boxH);
                            c.clip();

                            c.font = `bold ${fitFS}px Arial`;
                            c.textAlign = 'center';
                            c.textBaseline = 'middle';
                            lines.forEach((line, i) => {
                                const y = startY + i * lineHeightLocal;
                                if (line) {
                                    const textWidth = c.measureText(line).width;
                                    const paddingX = fitFS * 0.4;
                                    const paddingY = fitFS * 0.3;
                                    c.fillStyle = '#00B140';
                                    c.fillRect(
                                        obj.x + (obj.w - textWidth) / 2 - paddingX,
                                        y - lineHeightLocal / 2 - paddingY / 2,
                                        textWidth + paddingX * 2,
                                        lineHeightLocal + paddingY
                                    );
                                    c.fillStyle = '#00D4AA';
                                    c.fillText(line, obj.x + obj.w / 2, y);
                                }
                            });
                            c.restore();
                        } else {
                            // ‰ªÖÊ†áÁ≠æÔºöÂ±Ö‰∏≠ÊòæÁ§∫ÔºàÂØºÂá∫Ôºâ
                            c.save();
                            c.fillStyle = '#00D4AA';
                            c.font = 'bold 14px Arial';
                            c.textAlign = 'center';
                            c.textBaseline = 'middle';
                            // Â¢®ÁªøËâ≤ËÉåÊôØÂùóÔºàÂØºÂá∫ÂêåÊ†∑ÈÄÇÈÖçÔºâ
                            (function () {
                                const label = obj.label || 'Mask';
                                const fs = parseInt(c.font, 10) || 14;
                                const paddingX = Math.max(6, fs * 0.6);
                                const paddingY = Math.max(4, fs * 0.4);
                                const textWidth = c.measureText(label).width;
                                const cx = obj.x + obj.w / 2;
                                const cy = obj.y + obj.h / 2;

                                c.fillStyle = '#00B140';
                                c.fillRect(
                                    cx - textWidth / 2 - paddingX,
                                    cy - fs / 2 - paddingY,
                                    textWidth + paddingX * 2,
                                    fs + paddingY * 2
                                );

                                c.fillStyle = '#00D4AA';
                                c.fillText(label, cx, cy);
                            })();
                            c.restore();
                        }
                    }
                });

                return off.toDataURL('image/png');
            };

            // Ë∑üÈöèÊØî‰æã/ÊñπÂêë‰∏éÁ™óÂè£Â∞∫ÂØ∏ÂèòÂåñ
            window.addEventListener('resize', () => updateWorkspaceSize());

            // Áî®Â∑•‰ΩúÁ©∫Èó¥ÈÄªËæëÊé•ÁÆ° generateGreenscreenÔºà‰øùÊåÅÊèêÁ§∫ËØçÂå∫ÂüüÊòæÁ§∫Ôºâ
            const __origGen = window.generateGreenscreen;
            window.__workspaceActive = true;
            window.generateGreenscreen = function () {
                if (typeof updatePromptText === 'function') updatePromptText();
                document.getElementById('result-section')?.classList.add('show');
            };

            // ÂàùÂßã
            window.addEventListener('load', () => {
                updateWorkspaceSize();
                refreshMaskList();
                // ÂàùÂßãÂà∑Êñ∞ÂõæÂ±ÇÊ†è
                if (typeof refreshLayersPanel === 'function') refreshLayersPanel();
            });
        })();
    </script>
</body>

</html>